# GameWorld Scene Spec (MVP)

## 1. 목적
- 오픈월드 단일 씬에서 **탐험, NPC 상호작용, 영토 확장, 영웅 관리**를 구현하기 위한 HUD 및 상호작용 규칙을 정의한다.
- 64×64 청크 스트리밍 구조와 NPC 반경 기반 상호작용을 대비해 UI/데이터 의존 관계를 명확히 한다.

## 2. 주요 시스템 개요
| 시스템 | 설명 | 참고 문서 |
| --- | --- | --- |
| 이동/조우 | 8방향 이동, 10% 전투 조우, 요새 강제 전투 | `docs/01-systems/world-exploration.md` |
| NPC 서비스 | 상점, 여관, 술집, 대장간 등 | `docs/01-systems/settlement.md`, `docs/01-systems/shop.md` |
| 영토/깃발 | 설치 모드 토글, 범위 하이라이트, 계급 갱신 | `docs/01-systems/territory.md`, `docs/01-systems/progression.md` |
| 파티/영웅 관리 | 영웅 배치, 프리셋, 장비 확인 | `docs/01-systems/hero.md`, `docs/01-systems/combat.md` |

## 3. HUD 구성
| 영역 | 요소 | 설명 |
| --- | --- | --- |
| 상단 좌측 | 미니맵 토글, 미니맵(영토 시야 포함) | 토글로 ON/OFF 가능. 미니맵에는 탐험/미탐험/영토 보유 구역을 색상으로 구분한다. |
| 상단 우측 | 골드, 계급, 깃발 보유량 | 깃발 수량은 `현재/최대` 형식(예: `3/20`)으로 표시. 계급 변동 시 토스트/애니메이션. |
| 좌측 중단 | 파티/영웅 HUD 스트립 | 각 영웅의 초상화, HP, 사망 상태 표시. 터치/클릭 시 전투력/능력치 상세 패널(모달) 오픈. |
| 하단 좌측 | 이동 조작 패드 | 모바일/패드 공용. 진동 피드백 없음. |
| 하단 우측 | 캠핑 버튼, 깃발 모드 토글, 기타 액션 | 캠핑 중에는 이동 입력 잠금. 깃발 모드 토글 시 설치 UI 활성화. |
| 상호작용 프롬프트 | NPC/오브젝트 근접 시 버튼/버블 표시 (`상호작용`) | 반경 내 유지 시만 표시, UI.ModalLayer에서 패널 오픈. |

## 4. NPC 인터랙션
| NPC | 패널 | 전달 데이터 | 비고 |
| --- | --- | --- | --- |
| 상점 주인 | 상점 탭 UI (장비/공용/깃발) | `/shop/list`, 플레이어 골드/계급 정보 | 정확한 위치는 타일 설계 시 지정. |
| 여관 주인 | HP 전액 회복 컨펌 모달 | `/tavern/heal` (Stub) | 위치 TBD. |
| 술집 | 영웅 모집 패널, 파티 프리셋 저장/불러오기 | `/tavern/recruit`, `/party/preset` (Stub) | 위치 TBD. |
| 대장간 | 강화/합성/보석/옵션 탭 | `/forge/*` | 위치 TBD. |
| 정보 NPC(Stub) | 요새 정보/도전 권유 | `/enemy/fortress-info` (Stub) | 필요 시 배치. |

반경 판정은 Trigger Collider 기반(예: 반경 2타일). 플레이어가 진입하면 HUD에 상호작용 버튼이 나타나고, 버튼/터치를 통해 UI.ModalLayer가 해당 패널을 연다. NPC 좌표는 월드 타일 설계 단계에서 확정한다.

## 5. 영웅 정보 & 파티 관리
- 좌측 HUD 스트립: 현재 파티 영웅의 HP/사망 상태를 실시간으로 표시하며, 터치/클릭 시 전투력·능력치 상세 모달을 열 수 있다.  
- 파티 프리셋 저장/불러오기, 신규 영웅 영입은 **술집 NPC** UI에서만 수행한다.  
- 장비 확인/교체는 월드 어디서든 HUD 모달을 통해 접근 가능하되, 상점/대장간과 연계되는 기능은 NPC 패널로 이동.  
- 몬스터 조우 시 CombatOverlay 로딩 전에 **배치 UI**가 노출되며, 플레이어가 변경하지 않으면 이전 전투와 동일한 배치를 자동으로 사용한다.  
- 동일 파티 구성에서 변경 없이 전투를 반복하는 경우, 마지막 배치를 기본값으로 기억한다.

## 6. 깃발 설치 모드
1. HUD `깃발 모드` 토글 → 설치 가능한 타일을 하이라이트.  
2. 플레이어 이동 시 후보 타일(현재 위치 기준) 표시.  
3. 설치 버튼 입력 → `/territory/flag` 요청 → 성공 시 영토 타일맵 갱신, 계급 재평가 알림.  
4. 제거는 설치된 깃발 위에서 동일 입력 → 컨펌 모달 → 성공 시 깃발 반환/영토 감소.  
5. 하이라이트/영토 표현은 청크 스트리밍과 연동해 필요 청크만 갱신.

## 7. 전투 조우
- 이동 입력마다 WebSocket으로 좌표 이벤트 전송 → 서버가 전투 여부 판단.  
- 전투 발생 시, 우선 GameWorld에서 배치 UI(기존 배치 확인/수정) 노출 → `전투 시작` 선택 시 `CombatOverlay`를 Additive 로드한다.  
- 전투 중 HUD는 일시 비활성화되고 캐릭터 이동이 잠금된다.
- CombatOverlay 종료 후 서버가 보상과 현재 좌표(원래 위치 또는 요새 입구)를 내려주면 HUD를 갱신하고 이동을 재개한다.

## 8. 청크 스트리밍
- 타일맵/데코/콜라이더를 64×64 타일 기준 프리팹으로 분리.  
- `ChunkStreamer` 서비스가 플레이어 위치 기준 N×N 청크만 활성화 (기본 3×3).  
- Addressables 또는 Additive SubScene을 사용해 청크 로드/언로드.  
- 로딩 중에는 해당 영역 미니맵/시야를 비활성화하고, 완료 시 HUD에 로딩 상태를 표시.  
- 요새/특수 지형은 사전 로딩 목록에 추가해 끊김 최소화.  
- QA를 위해 디버그 모드에서 로드된 청크 목록 및 DrawCall을 HUD에 표시.

## 9. 데이터 의존성
| API/데이터 | 설명 |
| --- | --- |
| `/player/profile` | 골드, 계급, 깃발 보유량, 파티 정보, 마지막 좌표. |
| `/world/state` | 필드/요새 기본 데이터, 금지 타일, 이벤트 상태. |
| `/shop/list`, `/shop/purchase` | 상점 패널. |
| `/tavern/recruit`, `/tavern/heal` | 술집/여관 패널 (Stub). |
| `/forge/*` | 대장간 기능 (Stub). |
| `/territory/flag`, `/territory/list` | 깃발 설치/조회. |
| WebSocket channels | 이동 이벤트, 전투 알림, 실시간 공지, 월드 이벤트. |

## 10. 오류 & 엣지 케이스
- NPC 패널 열기 실패 → Toast + 재시도 버튼, 특정 기능 비활성화.  
- 깃발 설치 실패(자원 부족, 계급 조건 미달) → 모달에 오류 메시지.  
- 전투 직후 이동 이벤트 실패 → 좌표 재동기화 API 호출.  
- 청크 로딩 실패 → 기본 타일(Placeholder)로 대체하고 재시도 로직.  
- WebSocket 끊김 → HUD 상단 경고 표시, 자동 재연결 시도.

## 11. Stub / 향후 과제
1. 요새/스토리 이벤트 컷씬 시스템 설계.  
2. 월드 이벤트(자원 노드, 보스 소환) 알림 UI.  
3. 파티 편성 상태 공유(길드/친구에게 위치 전송) 기능.  
4. 이동 경로 미리보기, 자동 이동 기능 고려.  
5. 모바일 제스처/버튼 최적화(조작 패드 커스터마이즈 등).

---
**최종 수정**: 2025-10-26  
**상태**: 1차 검수 완료  
**작성자**: SangHyeok  
