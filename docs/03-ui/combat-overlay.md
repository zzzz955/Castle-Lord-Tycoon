# CombatOverlay Scene Spec (MVP)

## 1. 목적
- 서버에서 계산된 전투 로그를 **UI 기반으로 재생**하고, 배치/속도 조절/보상 확인을 제공하는 오버레이 씬의 동작을 정의한다.
- GameWorld와 긴밀히 연동해 전투 시작/종료 시점의 플레이어 상태를 정확히 동기화한다.

## 2. 구조 개요
| 단계 | 설명 |
| --- | --- |
| 1. 호출 | GameWorld가 전투 트리거를 수신하면 `CombatOverlay` Additive 씬을 로드하고 GameWorld 입력을 잠금. |
| 2. 배치 | 3×3 아군 슬롯, 적군 프리뷰, `도망`, `전투 시작` 버튼 제공. |
| 3. 전투 | 서버 로그 재생, 속도(1×/2×/4×/8×), 스킵, 리플레이 옵션. |
| 4. 결과 | 경험치/골드/드랍, 영웅 레벨업, 전투 로그 저장 여부 선택. |
| 5. 종료 | `확인` 버튼 → 씬 언로드 → GameWorld 시간 재개. |

## 3. UI 상세
| 영역 | 요소 | 설명 |
| --- | --- | --- |
| 좌측 그리드 | 아군 3×3 UI 슬롯 | 스프라이트 + HP 게이지 + 속성 아이콘. |
| 우측 그리드 | 적군 3×3 UI 슬롯 | 등장 몬스터 미리보기, 속성 표시. |
| 상단 HUD | 라운드 카운터, 전투 시간, 자동/스킵 버튼 | 라운드 진행에 맞춰 업데이트. |
| 하단 패널 | 배치 탭, 로그 탭 | 배치 단계에서는 슬롯 조정, 전투 중에는 로그 텍스트. |
| 결과 패널 | 전리품 리스트, 경험치 분배, 버튼 | `확인`, `재전투`, `리플레이` (Stub). |

## 4. 상호작용 플로우
### 4.1 배치 단계
1. GameWorld가 전달한 파티 구성/기본 배치를 로드.  
2. 플레이어가 Drag & Drop 또는 버튼으로 슬롯을 변경.  
3. `도망` 선택 시 전투없이 월드 복귀(`/world/escape` 호출).  
4. `전투 시작` → 서버 `/combat/start` API 호출(파티 정보+배치).  
5. 응답에 전투 로그, 보상, 결과 요약 포함.

### 4.2 로그 재생
- 로그 항목 구조: `round`, `actorId`, `action`, `targetId`, `damage`, `critical`, 기타 이펙트.  
- Timeline 재생 방식:
  1. 라운드 단위로 UI 애니메이션 재생.  
  2. 스킵 버튼 → 즉시 결과로 이동.  
  3. 속도 버튼 → 애니메이션 시간 스케일 조정.  
- 탄환/이펙트는 UI Animation 또는 Spine 2D(Stub) 활용 가능. MVP에서는 최소 HP 게이지/피격 이펙트만 구현.

### 4.3 결과 처리
- 승리: 경험치/재화/드랍 목록 표시 → `확인` 시 GameWorld에 결과 전달.  
- 패배: 패배 메시지 + `마을 귀환` 버튼 → GameWorld 좌표 강제 이동.  
- 무승부: 전투 종료 알림 + 보상 없음.  
- `재전투` 버튼은 요새/스토리 전투용 Stub, MVP에서는 숨김.

## 5. 데이터 의존성
| API/데이터 | 설명 |
| --- | --- |
| `/combat/start` | 배치 정보 포함, 전투 로그/결과 반환. |
| `/combat/result` (Stub) | 리플레이 재요청 또는 추가 검증용. |
| `PlayerDataStore` | 파티 구성, 영웅 스탯, 장비. |
| `GameWorld` 상태 | 전투 종료 후 위치/상태 업데이트. |
| 애니메이션 리소스 | 영웅/몬스터 기물, 공격 이펙트, 사망 연출. |

## 6. 오류 & 예외
- API 실패 → Toast + `재시도` 버튼, 세 번 실패 시 타이틀로 복귀 안내.  
- 로그 파싱 오류 → 전투 무효 처리, 보상 없음, 고객센터 안내.  
- 전투 중 연결 끊김 → 재로그인 유도, 전투 결과 서버 기준으로 처리.  
- 도망 시 실패(강제 전투) → 경고 모달 + 버튼 비활성화.

## 7. Stub / 향후 과제
1. Rich Replay 저장/재생 기능, 소셜 공유.  
2. PvP/길드전 모드용 UI 확장.  
3. 자동 전투 설정(스킬 우선순위, 포메이션 프리셋).  
4. 배치 추천/자동 편성(추천 영웅, 속성 시너지).  
5. 전투 로그 분석 그래프(딜량, 힐량 등).

---
**최종 수정**: 2025-10-26  
**상태**: 초안  
**작성자**: SangHyeok  
