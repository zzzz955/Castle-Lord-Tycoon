# CombatOverlay Scene Spec (MVP)

## 1. 목적
- 서버에서 계산된 전투 로그를 **UI 기반으로 재생**하고, 배치/속도 조절/보상 확인을 제공하는 오버레이 씬의 동작을 정의한다.
- GameWorld와 긴밀히 연동해 전투 시작/종료 시점의 플레이어 상태를 정확히 동기화한다.

## 2. 구조 개요
| 단계 | 설명 |
| --- | --- |
| 1. 호출 | GameWorld가 전투 트리거를 수신하면 `CombatOverlay` Additive 씬을 로드하고 GameWorld 입력을 잠금. |
| 2. 전투 준비 | GameWorld에서 전달된 배치 정보를 표시하고 `도망` 버튼만 제공(배치 수정 없음). |
| 3. 전투 재생 | 서버 로그를 자동 재생(기본 1×). 배속/스킵 버튼으로 제어 가능. |
| 4. 결과 | 1차(전투 요약) → 2차(보상 정산) 패널 순서로 표시. |
| 5. 종료 | `확인` 버튼 → 씬 언로드 → GameWorld 시간 재개. |

## 3. UI 상세
| 영역 | 요소 | 설명 |
| --- | --- | --- |
| 좌측 그리드 | 아군 3×3 UI 슬롯 | 스프라이트 + HP 게이지 + 버프/디버프 아이콘. |
| 우측 그리드 | 적군 3×3 UI 슬롯 | 스프라이트 + HP 게이지 + 버프/디버프 아이콘. |
| 상단 HUD | 좌측 아군 초상화 스트립, 중앙 라운드/시간, 우측 적군 초상화 스트립 | 초상화에는 속성 아이콘(좌측 상단)과 사망 시 시각적 마커(X 오버레이 등)를 표시한다. |
| 하단 좌측 | 배속 버튼(1×/2×/4×/8×) | 버튼 상태에 따라 전투 로그 재생 속도 변경. |
| 하단 우측 | 스킵 버튼 | 즉시 전투 결과 패널로 이동. |
| 하단 중앙 | Combat Log 탭 | 전투 중 텍스트 로그 확인. |

## 4. 상호작용 플로우
### 4.1 배치 데이터 전달
- 영웅 배치/편성은 **GameWorld HUD의 ‘파티 관리’ UI**에서 이루어진다(`docs/03-ui/gameworld-hud.md`).  
- 플레이어가 전투를 개시하면 GameWorld가 현재 배치 정보를 CombatOverlay에 전달하고, CombatOverlay는 이를 단순 표시만 한다.  
- CombatOverlay 내에서는 배치 수정 기능을 제공하지 않는다.  
- `도망` 버튼 선택 시 `/world/escape` 호출 후 GameWorld로 즉시 복귀.

### 4.2 전투 시작
1. CombatOverlay가 호출되면 곧바로 서버 `/combat/start` API를 요청한다(전투는 자동).  
2. 응답에는 전투 로그, 라운드별 상태, 보상 요약이 포함된다.  
3. 로그를 수신한 뒤 배속/스킵 버튼을 활성화해 플레이어가 재생 방식을 선택할 수 있게 한다.

### 4.2 로그 재생
- 로그 항목 구조: `round`, `actorId`, `action`, `targetId`, `damage`, `critical`, 기타 이펙트.  
- Timeline 재생 방식:
  1. 라운드 단위로 UI 애니메이션 재생.  
  2. 스킵 버튼 → 즉시 결과로 이동.  
  3. 속도 버튼 → 애니메이션 시간 스케일 조정.  
- 탄환/이펙트는 UI Animation 또는 Spine 2D(Stub) 활용 가능. MVP에서는 최소 HP 게이지/피격 이펙트만 구현.

### 4.3 결과 처리
- **1차 결과 패널 – 전투 요약**  
  - 좌측: 생존한 아군 초상화/HP/사망 표시.  
  - 우측: 적군 초상화/HP/사망 표시.  
  - 중앙: 라운드 수, 승패, 전투 시간, 전투 로그 분석 그래프(딜량/힐량 등).  
  - 버튼: `확인`, `리플레이`(동일 로그 재생).  
- **2차 결과 패널 – 보상 정산**  
  - 전리품 리스트, 경험치 분배, 골드 표시.  
  - 버튼: `확인` → GameWorld에 결과 반영.  
- 패배 또는 무승부 시 1차 패널에서 결과 안내 후 GameWorld로 귀환(보상 없음).  
- 재전투 기능은 MVP 범위에서 제공하지 않는다.

## 5. 데이터 의존성
| API/데이터 | 설명 |
| --- | --- |
| `/combat/start` | 배치 정보 포함, 전투 로그/결과 반환. |
| `/combat/result` (Stub) | 리플레이 재요청 또는 추가 검증용. |
| `PlayerDataStore` | 파티 구성, 영웅 스탯, 장비. |
| `GameWorld` 상태 | 전투 종료 후 위치/상태 업데이트. |
| 애니메이션 리소스 | 영웅/몬스터 기물, 공격 이펙트, 사망 연출. |

## 6. 오류 & 예외
- API 실패 → Toast + `재시도` 버튼, 세 번 실패 시 타이틀로 복귀 안내.  
- 로그 파싱 오류 → 전투 무효 처리, 보상 없음, 고객센터 안내.  
- 전투 중 연결 끊김 → 재로그인 유도, 전투 결과 서버 기준으로 처리.  
- 도망 시 실패(강제 전투) → 경고 모달 + 버튼 비활성화.

## 7. Stub / 향후 과제
1. Rich Replay 저장/재생 기능, 소셜 공유.  
2. PvP/길드전 모드용 UI 확장.  
3. 배치 추천/자동 편성(추천 영웅, 속성 시너지).  
4. 전투 로그 분석 그래프 고도화(패널1 통합 시각화, 히트맵 등).  
5. 스킵 조건(속성/난이도 별 해금) 정책 정의.

---
**최종 수정**: 2025-10-26  
**상태**: 1차 검수 완료
**작성자**: SangHyeok  
