# Combat System

## 목적
- 3×3 격자 기반 자동 전투에서도 배치·조합 전략을 유지하고 짧은 루프를 제공한다.
- 전투 계산은 서버에서 수행하고, 클라이언트는 전투 로그 재생과 UX만 담당한다.
- 전투 파라미터는 `battle_rules.csv`, `monster_templates.csv` 등 메타데이터로 제어한다.

## 전투 단계 요약
1. **파티 준비**: 마을에서 파티원을 확정하고 필드로 출발한다.
2. **필드 조우**: 필드 이동 중 확률적으로 적과 마주치며 조우 연출을 재생한다.
3. **전투 배치**: 양측 3×3 격자에서 배치를 확정한다.
4. **전투 진행**: 서버가 전투를 계산하고 클라이언트는 로그를 재생한다.
5. **전투 결과**: 보상, 경험치, 소지 재화를 동기화한다.

## 1. 파티 준비
- 마을에서 확정한 파티 구성(최소 1명)은 필드에서 고정되며, 전투 배치 화면에서는 위치만 조정할 수 있다.
- 마을에서 파티 정보를 갱신하면 새 배치 기본값이 초기화된다.

## 2. 필드 조우
- 필드를 순회하다가 독립 확률 시행으로 최대 3~4마리 몬스터가 슬롯별로 등장한다.
- 조우 시 애니메이션과 스토브 메시지를 노출한 뒤 1초 후 전투 배치 UI가 열린다.
- 요새(던전 보스) 전투는 예외적으로 랜덤 없이 6마리 몬스터가 고정 등장한다.

## 3. 전투 배치 UI
- UI는 좌측 아군, 우측 적군 3×3 격자를 사용한다.
- 아군은 직전 전투에서 사용한 좌표를 우선 적용한다. 이력이 없거나 마을에서 파티를 갱신했다면 파티 순서대로 7→4→1→8 슬롯에 자동 배치한다(1-based 인덱스).
- 아군 그리드 번호는 다음과 같다.

```
7 4 1
8 5 2
9 6 3
```

- 적군은 내부적으로 동일한 1~9 인덱스를 사용하되, UI에서는 좌우 반전된 형태로 표현한다.

```
1 4 7
2 5 8
3 6 9
```

- 적군 몬스터는 전투마다 등장 몬스터 수(3~4마리)에 맞춰 랜덤 슬롯에 배치되며, 요새 전투는 6슬롯을 고정 사용한다.
- 전투 배치 화면에는 영웅·몬스터 초상화를 표시한다.
- 배치 완료 후 플레이어는 `전투 시작` 또는 `도망가기`를 선택할 수 있다. 도망가기를 선택하면 전투 없이 탐험을 이어가고, 전투 시작을 누르면 전투 단계로 진입한다.

## 4. 전투 진행

### 표현
- 격자에는 영웅 타입(공격형, 방어형, 균형형)에 맞는 공용 기물을 사용한다. 예) 방어형=창과 방패 전사, 공격형=궁수·머스킷티어, 균형형=로브 사제.
- 몬스터는 전용 기물을 사용하며, 리소스가 준비되면 데이터 참조만 교체해 즉시 적용 가능해야 한다.
- 전투 중 사망한 유닛은 격자에서 제거하고, 상단 초상화에는 X 오버레이를 씌워 전투 불능 상태를 표시한다.
- 전투 UI 상단에는 모든 영웅/몬스터 초상화를 배치하고, 재생 속도(1×/2×/4×/8×)와 스킵 버튼을 제공한다.

### 시작 효과
- 전투 돌입 시 영웅·몬스터의 전투 개시 효과를 즉시 발동한다.
- 아군 4명이 동일 속성일 경우 속성 시너지 보너스를 적용한다.
- 전투 시작 이후 추가로 획득한 공격/방어 스탯은 기물 옆에 이모지로, 상단 초상화 아래에는 증가 수치를 %로 표시한다.

### 턴 순서와 행동
- 선공은 항상 아군이며, 1→9 슬롯 순으로 아군 → 적군이 번갈아 행동한다.
- 사망한 유닛의 턴은 스킵하고 다음 유닛으로 넘어간다. 양측 인원 수가 달라도 동일한 규칙을 따른다.
- 방어형 기물은 접촉 공격, 공격형·균형형 기물과 해당 타입의 몬스터는 원거리 연출을 사용한다.

### 라운드 및 종료 조건
- 모든 유닛이 한 번씩 행동하면 1라운드가 종료된다.
- 최대 20라운드까지 진행하고 승부가 나지 않으면 무승부 처리한다(보상 없음, 상태는 그대로 유지).
- 한쪽이 전멸하면 즉시 전투가 종료된다. 아군 전멸 시 패배 처리 후 마을로 강제 귀환하며, 영웅들은 마을에서 회복된다.

### 로그 재생·스킵·리플레이
- 전투 계산은 서버에서 수행하고, 클라이언트는 서버에서 내려 준 로그를 재생한다.
- 플레이어는 2×/4×/8× 속도를 선택하거나 전투 전체를 스킵할 수 있다.
- 전투 결과 화면에서는 동일 로그로 즉시 리플레이를 볼 수 있으나, 결과 창을 닫으면 리플레이 데이터는 폐기하고 별도 저장은 하지 않는다.

## 5. 전투 결과
- 결과 화면에는 획득 경험치, 재화, 전리품을 노출한다.
- 경험치는 `(몬스터 경험치 총합 × 경험치 획득량 증가 수치) ÷ 생존 영웅 레벨 합 × 각 영웅 레벨` 공식을 사용해 생존 영웅별로 분배한다.
- 재화와 전리품은 확률 드랍이며 파티의 드랍률 증가 수치가 적용된다. 골드는 추가로 `(총 드랍 수치 × 골드 획득량 증가 수치)` 결과를 사용한다.
- 서버는 전투 수행 시점에 계산된 전리품과 함께 최신 소지 재화 값을 내려 보낸다. 클라이언트는 기존 값에 더하지 않고 수신한 값을 그대로 대입해 동기화와 변조 방지를 확보한다.

## 데이터 및 의존성
- `data/battle_rules.csv`: 격자 크기, 턴 우선순위, 라운드 제한 등.
- `data/battle_modes.csv`: 파티 크기, 요새/필드 구분.
- `data/monster_templates.csv`: 등장 몬스터 풀과 등장 확률.
- `data/combat_effects.csv`: 전투 시작 효과, 버프/디버프 정의.
- `data/reward_tables.csv`: 기본 보상, 드랍 확률.
- `docs/01-systems/world-exploration.md`: 필드 조우 로직.
- `docs/01-systems/character.md`: 영웅 속성, 타입, 시너지 정의.
- `docs/01-systems/equipment.md`: 장비와 강화가 전투에 미치는 영향.
- `docs/04-technical/client-server-contract.md`: `/combat/start`, `/combat/resolve` API 프로토콜.

---
**최종 수정**: 2025-10-21  
**상태**: 개편  
**작성자**: SangHyeok  
