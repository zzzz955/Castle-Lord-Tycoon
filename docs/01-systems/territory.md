# 깃발 & 영토 시스템

## 1. 개요
- 깃발은 필드에서 영토를 편입하고 점령한 마을/요새를 연결하기 위한 핵심 수단이다.
- 깃발 설치 시 깃발 크기(N×N)에 해당하는 타일이 플레이어 소유 영토로 편입된다.
- 누적 영토 수치는 플레이어 계급(성주/자작/후작/대신 등)을 결정하며, 계급은 다른 시스템(상점, 깃발 구매 한도 등)에 영향을 미친다.
- 본인이 이미 점령한 마을/요새는 깃발 연결이 끊어져도 소유권을 유지한다.

## 2. 깃발 설치 모드
- 필드 탐험 UI에서 토글 버튼으로 설치 모드를 켜면, 플레이어 캐릭터가 서 있는 타일을 기준으로 깃발 설치/제거를 수행한다.
- 설치 요청 → 현재 타일에 깃발이 없으면 설치, 이미 깃발이 있으면 제거 로직이 실행된다.
- 이동 불가 지형(물, 용암, 벽 등)은 영토 편입 대상에서 제외된다. 단, 이미 점령한 마을 내부 타일은 예외 없이 소유 영토로 인정된다.
- 타일 겹침 허용: 깃발 범위가 서로 겹치더라도 설치 가능하지만, 겹치는 영역은 추가 영토 점수에 기여하지 않는다.

## 3. 깃발 제거
- 깃발이 설치된 타일에서 다시 설치를 시도하면 해당 깃발이 제거된다.
- 제거 시 깃발이 편입했던 영토만큼 소유 영토 수치가 감소한다(겹친 영역은 제거 대상에서 제외).
- 이미 점령한 마을/요새의 소유권은 유지되며, 깃발이 없어도 해제되지 않는다.
- 제거된 깃발은 인벤토리로 반환되어 보유 깃발 목록에 자동 반영된다(상태: “사용 중”). 보유 중인 계정 전체 깃발 수량에 포함되며, UI에 “사용 중” 표시로 구분한다.
- 깃발 설치/제거 요청 시 컨펌 모달을 표시하여 예상 영토 증가/감소 수치를 명시한다.

## 4. 깃발 종류
| 깃발 ID | 크기(N×N) | 가격(골드) | 요구 계급 | UI 표기(예시) |
| --- | --- | --- | --- | --- |
| FLAG_SMALL | 3×3 | 100 | 성주 | “소형 깃발” |
| FLAG_MEDIUM | 5×5 | 500 | 자작 | “중형 깃발” |
| FLAG_LARGE | 7×7 | 2,000 | 후작 | “대형 깃발” |
| FLAG_GRAND | 9×9 | 10,000 | 대신 | “거대 깃발” |

- 각 깃발은 계급 조건을 충족해야 구매/설치 가능하다.
- 깃발 설치 시 해당 깃발을 인벤토리에서 차감하고, 제거 시 반환 여부는 Stub.

## 5. 깃발 구매 및 관리
- 깃발은 상점의 “깃발 탭”에서 구매한다(상점 문서 참조). UI에는 현재 계급, 보유 골드, 보유 중인 깃발 수량(사용 중 포함), 구매 가능 한도가 표시된다.
- 각 계급별 구매 가능 수량/보유 한도는 `docs/01-systems/progression.md`와 연동해 정의한다.
- 플레이어는 보유 깃발 개수 내에서 설치/제거를 반복할 수 있으며, 설치된 깃발도 보유 목록에 “사용 중”으로 노출된다.
- 깃발은 상점에서 판매할 수 있으며, 판매 가격은 구매가의 25%(1/4)로 고정된다.

## 6. 영토 및 계급
- 깃발 설치/제거 시 영토 점수를 갱신하고, 누적 영토에 따라 계급을 재평가한다.
- 영토 점수는 타일 단위로 계산하며, 겹친 영역은 한 번만 카운트한다.
- 계급에 따라:
  - 깃발 구매 가능 크기/수량 제한.
  - 추가 혜택(상점 품목, 드랍률, 이동 옵션 등)을 확장할 수 있다(Stub).
- 최고 계급(황제)은 소유 영토 10,000 이상에서 달성하도록 계획하며, 맵 전체 타일 수는 이보다 큰 값으로 설계해 확장 여지를 확보한다. 이에 맞춰 대규모 타일 저장 구조(쿼드트리, 청크 분할 등)를 검토한다.

## 7. 미니맵 및 시각화
- 미탐험 지역: 검은색 전장의 안개로 표현.
- 탐험 완료(비소유) 지역: 회색 전장의 안개(타일은 보이되 소유권 없음).
- 소유 영토: 밝은 톤/연한 연두색으로 강조해 본인 소유임을 표시.
- 설치한 깃발 위치는 미니맵에 검은 점으로 표시하며, 선택 시 깃발 범위를 하이라이트하는 기능을 제공한다(Stub).

## 8. 데이터 구조 제안
| 파일 | 설명 |
| --- | --- |
| `flag_templates.csv` | 깃발 종류, 크기, 가격, 요구 계급, 이름/설명 |
| `flag_inventory.csv` | 플레이어 보유 깃발 수량 |
| `territory_state.csv` | 플레이어 영토 점수, 마지막 갱신 시점 |
| `rank_requirements.csv` | 계급별 누적 영토 요구량, 혜택 |
| `forbidden_tiles.csv` | 영토 편입 불가 지형 정의 |

## 9. Stub / 남은 과제
1. 계급별 깃발 구매 한도와 영토 요구량 수치 확정.
2. 깃발 설치 UI(미니맵 강조, 범위 미리보기) 설계.
3. 영토 데이터 최적화 및 저장 구조(대규모 타일 관리) 검토.
4. 설치/제거 로그 및 알림(예: 영토 감소 경고) 처리 규칙 결정.

---
**최종 수정**: 2025-10-23  
**상태**: 개편  
**작성자**: SangHyeok  
