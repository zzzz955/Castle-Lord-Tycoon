# 월드 탐험

## 목적
- 거점과 필드를 왕복하며 전투와 영토 확장을 반복하는 게임의 핵심 루프를 담당한다.
- 필드마다 미리 정의된 몬스터 테이블과 요새 도전을 통해 진행 난도를 조절하되, 지형·바이옴·영토 상태와 관계없이 조우 확률과 기본 보상은 일정하게 유지한다.
- 서버가 탐험 상태를 권한 있게 추적하고, 클라이언트는 2D 아이소메트릭 타일 월드를 8방향 이동 방식으로 연출한다.

## 탐험 단계 요약
1. **거점 준비**  
   마을에서 파티를 정비하고 플로우(필드/요새)를 선택한다.
2. **튜토리얼 안전 구역**  
   첫 깃발을 설치하기 전까지는 몬스터가 등장하지 않는다. 술집에서 영웅을 모집하고 프리셋을 설정한 뒤, 상점에서 깃발을 구매해 필드에 진입한다.
3. **필드 순찰**  
   타일을 이동할 때마다 독립 시행으로 10% 조우 판정을 진행하며, 조우 성공 시 서버가 전투를 계산한다.
4. **전투 로그 재생**  
   서버 결과를 바탕으로 전투를 재생한다. 현재는 비전투 이벤트가 없으며, 관련 스펙은 추후 확정 예정이다.
5. **영토 확장**  
   필드에서 깃발을 설치해 새 타일을 영토로 편입하고, 전투/경제 보너스를 확보한다.
6. **야영 또는 귀환**  
   필드 어디서든 야영을 시작해 체력을 회복하거나, 원할 때 즉시 마을로 귀환해 루프를 다시 시작한다.

## 지형 구조
| 구역 타입 | 설명 | 기본 특성 |
| --- | --- | --- |
| 마을 | 플레이어 거점, NPC 인터랙션 허브 | 조우 없음, 서비스 이용, 영토 연결 시 전체 소유 가능 |
| 필드(Field) | 마을↔마을, 마을↔요새 사이의 야생 지대 | 타일 이동 시 10% 확률로 몬스터 조우 |
| 요새(Fortress) | 고정 배치 보스 전투 구역 | 진입 즉시 전투, 첫 승리 후 자유 이동 |

- 모든 타일은 마을/필드/요새 중 하나에 속하며, 같은 바이옴 비주얼을 사용하더라도 필드마다 별도 몬스터 테이블을 가진다.
- 요새는 최초 승리 전까지 내부 이동이 제한되지만, 도전 자체에는 영토 점수나 계급 요구가 없다.

## 마을과 NPC
- NPC가 배치된 타일에 근접하면 상호작용할 수 있으며, 마을·요새를 점령하지 않았더라도 접근만 하면 이용 가능하다.
- 플레이어 영토가 초기 마을에서 목표 마을/요새까지 끊김 없이 이어지면 점령으로 간주하며, 점령 팝업과 함께 해당 타일이 영토에 편입되었다는 알림을 제공한다.
- **술집 NPC**: 재화로 영웅을 모집하고 전투 프리셋을 편집·보관한다.
- **상점 NPC**: 장비·보석을 구매하거나 장비를 판매한다. 목록은 매일 갱신되며, 재화를 소모해 추가 갱신(일일 제한, 요새 간 공유)이 가능하다. 요새 상점은 높은 등급 아이템이 등장할 확률이 조금 더 높다.
- **여관 NPC**: 파티 영웅의 체력을 즉시 최대치까지 회복하며, 비용과 쿨타임이 없다.
- **대장간 NPC**: 장비 제작·분해 및 보석 각인 해제를 담당한다. 제작에는 재료와 재화가 필요하며, 분해 시 일부 재료를 회수한다.
- **이동 NPC**: 점령한 마을·요새 목록을 탭으로 제공하고, 선택한 거점으로 즉시 이동시킨다. 이동 종료 시 해당 거점의 이동 NPC 앞에 캐릭터가 배치된다.

## 요새
- 진입과 동시에 서버가 요새 전투를 판정한다.
- 첫 전투는 필드 몬스터보다 강한 편성으로 구성된다. 승리 전까지 요새 내부 NPC 상호작용과 이동이 제한된다.
- 첫 승리 이후에는 전투 없이 자유 이동이 가능하며, 이동 NPC를 통해 워프 거점으로 활용할 수 있다.
- 요새별 몬스터 구성과 보상은 필드보다 높은 난도를 가정하지만, 도전 조건은 없다.

## 이동과 시야
- 이동 입력은 8방향(상하좌우 + 대각선) 클릭/터치 기반이다.
- 이동 가능 타일과 불가능 타일을 타일 이미지로 구분해 UI에 표시한다.
- 기본 이동 속도는 100%이며, 계급 효과 등으로 +% 보정만 적용된다(감속 요소 없음).
- 타일을 변경하지 않고 머무르는 동안에는 몬스터 조우가 발생하지 않는다.
- 시야 상태는 `미탐색 → 탐색됨 → 영토 보유` 3단계로 관리한다.
- 깃발은 인접 타일의 시야를 주기적으로 밝혀 주며, 서버는 주기적으로 좌표와 시야 상태를 동기화한다.

## 조우와 몬스터
- **조우 판정**: 플레이어가 새로운 필드 타일로 이동할 때마다 10% 확률로 몬스터 조우가 발생한다(독립 시행).
- **필드 몬스터 테이블**: 필드마다 등장 몬스터와 레벨 범위가 지정된 표를 사용한다. 예) `필드001`은 레벨 1~4 몬스터 A/B/C를 각각 40%/30%/30% 확률로 선택하며, 조우 시 3~4마리가 편성되어 `몬스터A Lv3, 몬스터A Lv2, 몬스터C Lv4` 또는 `몬스터C Lv1, 몬스터B Lv4, 몬스터C Lv4, 몬스터A Lv1` 같은 조합이 등장할 수 있다.
- **강제 전투**: 요새 및 스토리 전투는 10% 판정과 무관하게 즉시 발동한다.
- **비전투 이벤트**: 현재 미구현 상태(stub). 향후 스펙 확정 시 본 섹션을 업데이트한다.
- 일반 전투는 서버의 결과에 따라 클라이언트가 3~4 슬롯 편성을 재생하며, 요새 전투는 6슬롯 고정 편성을 따른다.

## 야영과 귀환
- 필드 어디에서든 야영을 시작할 수 있으며, 야영 중에는 몬스터가 조우하지 않는다.
- 야영을 유지하는 동안 5초마다 파티원 최대 체력의 10%를 회복한다. 필요 시 언제든 야영을 해제하고 이동할 수 있다.
- 마을 귀환은 제한 없이 즉시 수행할 수 있으며, 쿨타임이나 비용이 없다.

## 영토 확장
- **깃발 설치**: 필드 타일에서 깃발을 설치하면 주변 3×3 타일이 플레이어 영토로 편입되며, 전투력·경험치·재화·전리품 획득률 보너스가 적용된다. 자세한 규칙은 `docs/01-systems/territory.md`를 참고한다.
- **영토 단계/계급**: 영토가 확장되면 계급 상승 조건을 충족할 수 있으며, 계급 보너스로 이동 속도 +% 등 긍정 효과가 추가된다.
- **요새 정복**: 요새는 영토 점수나 계급 조건과 관계없이 언제든 도전할 수 있다.

## 데이터 및 파이프라인 메모
- CSV 재작성 시 고려 항목:
  - `world_regions.csv`: 지역 ID와 필드/요새 구분.
  - `encounter_tables.csv`: 필드별 몬스터 목록, 레벨 범위, 출현 확률.
  - `territory_benefits.csv`: 깃발 설치 보너스와 계급 효과.
  - `event_catalog.csv`: 비전투 이벤트 확정 후 정의 예정(stub).
- 메타데이터 파이프라인은 시트 → CSV → JSON 변환과 해시/버전 갱신을 담당하며, 최신 규칙을 클라이언트에 동기화한다.

## 기술 고려 사항
- 서버는 좌표, 시야 상태, 조우 판정을 authoritative하게 처리하고, 클라이언트 입력은 검증 후 반영한다.
- 전투 진입 시 서버가 `/combat/start`를 통해 배치 정보를 내려주며, 클라이언트는 로그 재생 버튼(배속/스킵)을 제공한다.
- 탐험 관련 명령(이동, 깃발 설치, 야영, 귀환 등)은 `client-server-contract.md`에서 API/이벤트 형태로 재정의한다.

## 후속 작업
1. 필드 타일 레이아웃과 이동 불가 타일 정의.
2. 필드별 몬스터 테이블 초안 작성 및 검증.
3. 야영 UI/UX 와이어프레임 및 진행 상태 표시 방식 결정.
4. 깃발 설치 보너스 수치와 계급 보상을 `territory.md`와 동기화.
5. 비전투 이벤트 스펙 확정 후 `event_catalog` 구조 업데이트.

---
**최종 수정**: 2025-10-23  
**상태**: 개편  
**작성자**: SangHyeok  
